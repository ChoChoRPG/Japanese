<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Kotoba - Nihon Science</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary-blue: #0f172a;
            --secondary-blue: #1e293b;
            --accent-red: #e11d48;
            --science-cyan: #0ea5e9;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --bg-light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --radius: 16px;
            --font-jp: 'Noto Sans JP', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            background-color: var(--bg-light);
            line-height: 1.6;
            touch-action: manipulation;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky; top: 0; z-index: 100;
        }
        .logo { 
            font-size: 1.25rem; font-weight: 800; color: var(--primary-blue); 
            display: flex; align-items: center; gap: 8px; text-decoration: none;
        }

        /* --- LEVEL TABS --- */
        .level-tabs {
            display: flex; justify-content: center; gap: 10px; margin: 30px 0; flex-wrap: wrap;
        }
        .level-btn {
            padding: 8px 24px; border-radius: 50px; border: 1px solid var(--border);
            background: white; font-weight: 600; cursor: pointer; transition: 0.2s;
            color: var(--text-light);
        }
        .level-btn.active {
            background: var(--primary-blue); color: white; border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
        }

        /* --- FILTER & GRID --- */
        .filter-bar {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 20px;
        }
        .filter-btn {
            padding: 6px 16px; border-radius: 8px; border: 1px solid var(--border);
            background: white; font-size: 0.9rem; font-weight: 600; color: var(--text-light);
            cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px;
        }
        .filter-btn.active { background: #e0f2fe; color: var(--science-cyan); border-color: #bae6fd; }
        
        .search-input {
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border);
            margin-bottom: 30px; font-size: 1rem;
        }

        .kotoba-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; padding-bottom: 100px;
        }

        /* --- MINI CARD (Grid View) --- */
        .card-mini {
            background: white; border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; cursor: pointer; transition: transform 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .card-mini:hover { transform: translateY(-4px); border-color: var(--science-cyan); }
        .card-mini.mastered { border-left: 4px solid var(--success-green); }
        
        .mini-jp { font-size: 1.8rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 4px; }
        .mini-mean { font-size: 0.95rem; color: var(--text-dark); font-weight: 600; }
        .mini-romaji { font-size: 0.85rem; color: var(--text-light); font-family: monospace; }

        /* --- FLOATING ACTION BUTTON --- */
        .fab-quiz {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--accent-red); color: white;
            padding: 16px 24px; border-radius: 50px;
            font-weight: 700; box-shadow: 0 10px 25px rgba(225, 29, 72, 0.4);
            cursor: pointer; transition: 0.3s; z-index: 90;
            display: flex; align-items: center; gap: 8px; border: none;
        }
        .fab-quiz:hover { transform: scale(1.05); }

        /* --- QUIZ OVERLAY (One-by-One Flashcard Mode) --- */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
            flex-direction: column; opacity: 0; transition: opacity 0.3s;
        }
        .quiz-overlay.active { display: flex; opacity: 1; }

        .quiz-card {
            background: white; width: 90%; max-width: 400px; min-height: 500px;
            border-radius: 24px; position: relative; perspective: 1000px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .quiz-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
            border-radius: 24px; min-height: 500px;
        }
        .quiz-card.flipped .quiz-inner { transform: rotateY(180deg); }

        .quiz-front, .quiz-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 24px; padding: 30px; background: white;
        }

        .quiz-front { z-index: 2; }
        .quiz-back { transform: rotateY(180deg); background: #f0f9ff; border: 2px solid var(--science-cyan); }

        /* Typography Quiz */
        .q-kanji { font-size: 4rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 10px; }
        .q-furi { font-size: 1.2rem; color: var(--text-light); }
        .q-mean { font-size: 1.5rem; font-weight: 700; color: var(--accent-red); margin-bottom: 10px; }
        .q-romaji { font-size: 1rem; font-family: monospace; color: var(--text-dark); margin-bottom: 20px; }
        .q-ex { font-size: 0.9rem; color: var(--text-light); font-style: italic; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }

        /* Controls */
        .quiz-controls {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 16px; padding: 0 20px;
        }
        .quiz-btn {
            flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; border: none;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-show { background: var(--primary-blue); color: white; width: 80%; margin: 0 auto; }
        .btn-hard { background: var(--accent-red); color: white; } /* Lupa */
        .btn-easy { background: var(--success-green); color: white; } /* Ingat */
        
        .close-quiz { 
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.1); 
            border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; z-index: 3000;
        }

        /* SETUP SCREEN */
        .setup-card {
            background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 400px;
        }
        .form-select {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            margin-bottom: 20px; font-size: 1rem;
        }

        @media (max-width: 640px) {
            .kotoba-grid { grid-template-columns: 1fr; }
            .quiz-question { font-size: 3rem; }
            .q-kanji { font-size: 3.5rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <a href="../index.html" class="logo">
                <i data-lucide="arrow-left" size="20"></i>
                NIHON<span style="color:var(--accent-red)">SCIENCE</span>
                <span style="font-weight:400; font-size:0.9rem; color:var(--text-light); margin-left:8px;">| Kotoba Library</span>
            </a>
        </div>
    </header>

    <div class="container">
        
        <!-- Level Selection -->
        <div class="level-tabs">
            <button class="level-btn active" onclick="loadLevel('n5')">N5</button>
            <button class="level-btn" onclick="loadLevel('n4')">N4</button>
            <button class="level-btn" onclick="loadLevel('n3')">N3</button>
            <button class="level-btn" onclick="loadLevel('n2')">N2</button>
            <button class="level-btn" onclick="loadLevel('n1')">N1</button>
        </div>

        <!-- Search & Filters -->
        <input type="text" class="search-input" id="searchInput" placeholder="Cari kosakata..." oninput="filterKotoba()">
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">Semua</button>
            <button class="filter-btn" onclick="setFilter('mastered')" data-filter="mastered"><i data-lucide="check-circle-2" size="14"></i> Sudah Hapal</button>
            <button class="filter-btn" onclick="setFilter('unmastered')" data-filter="unmastered"><i data-lucide="circle" size="14"></i> Belum</button>
        </div>

        <!-- Grid (List View) -->
        <div id="kotobaGrid" class="kotoba-grid">
            <!-- JS Injection -->
        </div>

    </div>

    <!-- Floating Quiz Button -->
    <button class="fab-quiz" onclick="openQuizSetup()">
        <i data-lucide="brain-circuit"></i> Mulai Hafalan
    </button>

    <!-- Quiz Overlay -->
    <div class="quiz-overlay" id="quizOverlay" style="display: none;">
        <button class="close-quiz" onclick="closeQuiz()"><i data-lucide="x"></i></button>
        
        <!-- 1. Setup Screen -->
        <div id="quizSetup" class="setup-card">
            <h2 style="margin-bottom:20px; text-align:center; color:var(--primary-blue);">Mulai Sesi Belajar</h2>
            
            <label style="font-weight:700; display:block; margin-bottom:8px;">Target:</label>
            <select id="quizTarget" class="form-select">
                <option value="all">Semua Kosakata (Full Review)</option>
                <option value="unmastered">Hanya yang Belum Hapal (Fokus)</option>
                <option value="mastered">Review yang Sudah Hapal</option>
            </select>

            <div style="background:#f0f9ff; padding:12px; border-radius:8px; font-size:0.85rem; color:var(--text-light); margin-bottom:20px;">
                <i data-lucide="info" size="14" style="vertical-align:text-bottom"></i>
                Metode <strong>Active Recall</strong>: Kartu akan ditampilkan satu per satu. Jika Anda memilih "Lupa", kartu akan muncul lagi nanti sampai Anda ingat.
            </div>

            <button class="btn-show quiz-btn" style="width:100%; background:var(--accent-red); color:white;" onclick="initQuiz()">Mulai</button>
        </div>

        <!-- 2. Flashcard Game Screen -->
        <div id="quizGame" class="quiz-card" style="display:none;">
            <div class="quiz-inner" id="flashcardInner">
                
                <!-- FRONT -->
                <div class="quiz-front">
                    <div style="font-size:0.9rem; color:var(--text-light); margin-bottom:20px;">Apa artinya?</div>
                    <div class="q-kanji jp-text" id="qKanji"></div>
                    <div class="q-furi jp-text" id="qFuri"></div>
                    
                    <div class="quiz-controls">
                        <button class="quiz-btn btn-show" onclick="flipCard()">Lihat Jawaban</button>
                    </div>
                </div>

                <!-- BACK -->
                <div class="quiz-back">
                    <div class="q-mean" id="qMean"></div>
                    <div class="q-romaji" id="qRomaji"></div>
                    <div class="q-ex jp-text" id="qEx"></div>
                    <button onclick="playTTSCurrent()" style="background:#e0f2fe; border:none; width:40px; height:40px; border-radius:50%; margin:10px auto; cursor:pointer; color:var(--science-cyan); display:flex; align-items:center; justify-content:center;"><i data-lucide="volume-2"></i></button>

                    <div class="quiz-controls">
                        <button class="quiz-btn btn-hard" onclick="answer(false)">
                            <i data-lucide="x" size="18"></i> Lupa
                        </button>
                        <button class="quiz-btn btn-easy" onclick="answer(true)">
                            <i data-lucide="check" size="18"></i> Ingat
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentLevel = 'n5';
        let allData = [];
        let filteredData = []; // Untuk Grid
        let currentFilter = 'all';
        let masteryData = JSON.parse(localStorage.getItem('kotobaMastery')) || {};

        // Quiz State
        let quizQueue = [];
        let currentCard = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(window.lucide) lucide.createIcons();
            loadLevel('n5');
        });

        // --- LOAD DATA ---
        async function loadLevel(level) {
            currentLevel = level;
            
            // Update Tabs
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.toLowerCase() === level) btn.classList.add('active');
            });

            // Fetch Data
            try {
                const response = await fetch(`data/kotoba-${level}.js`); 
                if(!response.ok) throw new Error("File not found");
                allData = await response.json();
                filterKotoba(); 
            } catch (e) {
                console.warn("Mode Preview: Menggunakan Fallback Data", e);
                allData = generateFallbackData(); // Mock data
                filterKotoba();
            }
        }

        function generateFallbackData() {
            return [
                { kanji: 'Â≠¶Áîü', furigana: '„Åå„Åè„Åõ„ÅÑ', romaji: 'gakusei', mean: 'Mahasiswa', example: 'ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô„ÄÇ' },
                { kanji: 'ÂÖàÁîü', furigana: '„Åõ„Çì„Åõ„ÅÑ', romaji: 'sensei', mean: 'Guru', example: 'Áî∞‰∏≠ÂÖàÁîü„ÅØÂÑ™„Åó„ÅÑ„Åß„Åô„ÄÇ' },
                { kanji: 'È£ü„Åπ„Çã', furigana: '„Åü„Åπ„Çã', romaji: 'taberu', mean: 'Makan', example: 'ÂØøÂè∏„ÇíÈ£ü„Åπ„Åæ„Åô„ÄÇ' },
                { kanji: 'Ë¶ã„Çã', furigana: '„Åø„Çã', romaji: 'miru', mean: 'Melihat', example: 'Êò†Áîª„ÇíË¶ã„Åæ„Åô„ÄÇ' },
                { kanji: 'Ë°å„Åè', furigana: '„ÅÑ„Åè', romaji: 'iku', mean: 'Pergi', example: 'Â≠¶Ê†°„Å∏Ë°å„Åç„Åæ„Åô„ÄÇ' }
            ];
        }

        // --- RENDER GRID (List View) ---
        function renderGrid(data) {
            const grid = document.getElementById('kotobaGrid');
            grid.innerHTML = '';

            if(data.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-light);">Data tidak ditemukan.</div>`;
                return;
            }

            data.forEach(item => {
                const isMastered = masteryData[`${currentLevel}-${item.kanji}`];
                const masteredClass = isMastered ? 'mastered' : '';
                
                const card = document.createElement('div');
                card.className = `card-mini ${masteredClass}`;
                card.innerHTML = `
                    <div class="mini-jp jp-text">${item.kanji}</div>
                    <div class="mini-mean">${item.mean}</div>
                    <div class="mini-romaji">${item.romaji}</div>
                    ${isMastered ? '<div style="position:absolute; top:10px; right:10px; color:var(--success-green);"><i data-lucide="check-circle-2" size="20"></i></div>' : ''}
                `;
                // Klik untuk play sound
                card.onclick = () => playTTS(item.kanji);
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- FILTER ---
        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.filter === type) btn.classList.add('active');
            });
            filterKotoba();
        }

        function filterKotoba() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(item => {
                const matchText = item.kanji.includes(term) || item.romaji.includes(term) || item.mean.toLowerCase().includes(term);
                const isMastered = masteryData[`${currentLevel}-${item.kanji}`];
                let matchStatus = true;
                if (currentFilter === 'mastered') matchStatus = isMastered;
                if (currentFilter === 'unmastered') matchStatus = !isMastered;
                return matchText && matchStatus;
            });
            renderGrid(filteredData);
        }

        // --- TTS ---
        function playTTS(text) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ja-JP';
            window.speechSynthesis.speak(utter);
        }
        function playTTSCurrent() { if(currentCard) playTTS(currentCard.kanji); }

        // --- FLASHCARD QUIZ LOGIC ---
        function openQuizSetup() {
            document.getElementById('quizOverlay').style.display = 'flex';
            document.getElementById('quizSetup').style.display = 'block';
            document.getElementById('quizGame').style.display = 'none';
            document.getElementById('quizOverlay').classList.add('active');
        }

        function closeQuiz() {
            document.getElementById('quizOverlay').classList.remove('active');
            setTimeout(() => { document.getElementById('quizOverlay').style.display = 'none'; }, 300);
        }

        function initQuiz() {
            const target = document.getElementById('quizTarget').value;
            let pool = allData;

            if(target === 'mastered') pool = allData.filter(i => masteryData[`${currentLevel}-${i.kanji}`]);
            if(target === 'unmastered') pool = allData.filter(i => !masteryData[`${currentLevel}-${i.kanji}`]);

            if(pool.length === 0) return alert("Tidak ada kata yang cocok untuk kriteria ini.");

            // Shuffle FULL DATA
            quizQueue = pool.sort(() => 0.5 - Math.random());
            
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizGame').style.display = 'block';
            
            nextCard();
        }

        function nextCard() {
            if(quizQueue.length === 0) {
                alert("Sesi Belajar Selesai! üéâ");
                closeQuiz();
                filterKotoba(); // Refresh grid status
                return;
            }

            // Reset Flip
            const cardEl = document.querySelector('.quiz-card');
            cardEl.classList.remove('flipped');

            // Load Data
            currentCard = quizQueue[0]; // Peek first
            
            // Update UI
            setTimeout(() => { // Delay update content until flip back animation done if any
                document.getElementById('qKanji').innerText = currentCard.kanji;
                document.getElementById('qFuri').innerText = currentCard.furigana || '';
                document.getElementById('qMean').innerText = currentCard.mean;
                document.getElementById('qRomaji').innerText = currentCard.romaji;
                document.getElementById('qEx').innerText = currentCard.example || '';
            }, 200);
        }

        function flipCard() {
            document.querySelector('.quiz-card').classList.add('flipped');
            playTTS(currentCard.kanji); // Auto play sound on reveal
        }

        function answer(isKnown) {
            // Remove current from queue head
            const processedCard = quizQueue.shift();

            if(isKnown) {
                // Tandai hapal
                masteryData[`${currentLevel}-${processedCard.kanji}`] = true;
                localStorage.setItem('kotobaMastery', JSON.stringify(masteryData));
                // Lanjut ke kartu berikutnya
                nextCard();
            } else {
                // Jika lupa, tandai belum hapal
                if(masteryData[`${currentLevel}-${processedCard.kanji}`]) {
                    delete masteryData[`${currentLevel}-${processedCard.kanji}`];
                    localStorage.setItem('kotobaMastery', JSON.stringify(masteryData));
                }
                
                // Re-queue (Spaced Repetition Micro: muncul lagi nanti di sesi ini)
                // Masukkan kembali ke posisi acak di tengah/belakang antrian
                const insertIndex = Math.floor(Math.random() * (quizQueue.length - 1)) + 1;
                quizQueue.splice(insertIndex, 0, processedCard);
                
                nextCard();
            }
        }

    </script>
</body>
</html>
